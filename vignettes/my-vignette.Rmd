---
title: "Testing"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Tutorial}
  %\VignetteIndexEntry{Testing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE
)
```

```{r setup}
library(inedata)
library(dplyr)
```

# Package Tutorial

The `inedata` package allows to download datasets produced by INE Chile. The package communicates with an API REST, which makes it possible to retrieve many household survey datasets using R code. All the available data provided by this API corresponds to  files published on INE's web site. 

At the moment the API is restricted to the institutional network. Because of that the package works only in this environment. We hope to make the API available to the general public as soon as possible.     


## Getting catalog

`get_catalog()` returns a dataframe containing all the datasets available in the repository. It also adds summary data in the form of number of columns and rows per dataset (in the *n_col* and *n_row* columns, respectively). The *survey* column contains the survey where the dataset comes from. The *version* column indicates the year or quarter when the dataset was collected.      

```{r}
get_catalog()
```

The `dataset` parameter retrieves information for a specific survey. In this example we are using *ene*, which returns all the available versions for that survey. We will store the first file in a variable called `file`.  

```{r}
get_catalog(dataset = "ene")

file <-  get_catalog(dataset = "ene") %>% 
  dplyr::slice(1) %>% 
  pull(version)
```

## Getting columns

The `get_columns` function returns the columns for a specific file. We already have the name of one of the available versions. 

```{r}
get_columns("ene", file)
```


## Downloading data

To download a specific dataset we can use the `get_data` function. For instance, we can get the ENE data for a specific quarter or the 2020 ENUSC dataset.   
```{r}
first_rows1 <-  get_data(dataset = "ene", version = file) %>% 
  slice(1:5)

first_rows2 <-  get_data(dataset = "enusc", version = "2020" ) %>% 
  slice(1:5)

first_rows2
```
```{r}
get_catalog("ene")
```

**Important note: Due to the project being in a testing phase, the API only returns the first 300 rows of each file. This is done to facilitate testing.** 

The `get_many_data` function allows to download more than one dataset at the same time. In this example we are getting all the versions between August (2022-08-jas) and October (2022-10-son) 2022. 

The output is a list of *dataframes*. In this case we can see the *df_list* contains 3 elements.    

```{r}
df_list <-  get_many_data(dataset = "ene", from = "2022-08-jas", to = "2022-10-son" )
length(df_list)


```
We can convert the three *dataframes* into one table

```{r}
ene_table <-  df_list %>% 
  bind_rows()
  
```
**Important note:** different versions of the same dataset are not always compatible, so, the `bind_rows()` method won't always work. Be always careful when joining multiple versions and check their structure before proceeding. 

# API Tutorial

The R package works with a service developed in Python, whose documentation can be found 
[here](http://10.90.10.46:7000/docs).Below are the endpoints and a link to the documentation.

**Important note:** when interacting directly with the API, it is important to be aware that due to data format restrictions, any cells that were originally NA will be displayed as empty text.


## Returns available datasets and a summary of number of rows and columns per dataset

```{r, eval=FALSE}
http://10.90.10.46:7000/datasets
```

## Returns datasets for a specific product

```{r, eval=FALSE}
http://10.90.10.46:7000/datasets/{dataset}
```

## Returns the columns of a file

```{r, eval=FALSE}
http://10.90.10.46:7000/colnames/{dataset}/{version}

```

## Returns data from a file (300 rows at the moment)

```{r, eval=FALSE}
http://10.90.10.46:7000/data/{dataset}/{version}
```



