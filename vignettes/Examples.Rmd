---
title: "Examples"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE
)
```

```{r setup, include = FALSE}
library(inedata)
library(tidyverse)
library(plotly)
library(purrr)
library(kableExtra)
```

# Example 1

Let's suppose that we are interested in the evolution of the unemployment rate by sex over the last few quarters. In this case, we can use the `get_many_data()` function, as shown in the following example:

```{r, message=FALSE,warning=FALSE,results='hide'}
ene_serie <-  get_many_data(dataset = "ene", from = "2022-09-aso", to = "2023-07-jja", col_list = c("ano_trimestre", "mes_central", "cae_especifico", "fact_cal", "sexo"), memory_warning_limit = 10000)
```

Next, we can calculate the unemployment rate for men, women and nationwide.

```{r, warning=FALSE}
unemployment_serie <- ene_serie %>% 
  map_df(., . %>% mutate(fact_cal = as.numeric(gsub(",", ".", fact_cal)),
                         work_force = if_else(cae_especifico %in% 1:9, 1, 0),
                         unemployed = if_else(cae_especifico %in% 8:9, 1, 0)) %>%
           filter(work_force == 1) %>% 
           group_by(ano_trimestre, mes_central) %>% 
           summarise(work_force = round(sum(work_force*fact_cal), 0),
                     unemployed = round(sum(unemployed*fact_cal), 0)) %>% 
           mutate(unemployment_rate = round((unemployed/work_force)*100, 1)) 
  ) %>% 
  bind_rows(., map_df(ene_serie, . %>% mutate(fact_cal = as.numeric(gsub(",", ".", fact_cal)),
                                      work_force = if_else(cae_especifico %in% 1:9, 1, 0),
                                      unemployed = if_else(cae_especifico %in% 8:9, 1, 0)) %>%
                        filter(work_force == 1) %>% 
                        group_by(ano_trimestre, mes_central, sexo) %>% 
                        summarise(work_force = round(sum(work_force*fact_cal), 0),
                                  unemployed = round(sum(unemployed*fact_cal), 0)) %>% 
                        mutate(unemployment_rate = round((unemployed/work_force)*100, 1)))) %>% 
  mutate(sexo = if_else(is.na(sexo), "Nationwide total",
                        if_else(sexo==1, "Men", "Women")),
         ano_trimestre=as.factor(ano_trimestre),
         periodo = case_when(mes_central==1 ~ "dic-feb",
                             mes_central==2 ~ "ene-mar",
                             mes_central==3 ~ "feb-abr",
                             mes_central==4 ~ "mar-may",
                             mes_central==5 ~ "abr-jun",
                             mes_central==6 ~ "may-jul",
                             mes_central==7 ~ "jun-ago",
                             mes_central==8 ~ "jul-sep",
                             mes_central==9 ~ "ago-oct",
                             mes_central==10 ~ "sep-nov",
                             mes_central==11 ~ "oct-dic",
                             mes_central==12 ~ "nov-ene"),
         periodo = factor(periodo,  levels=c("dic-feb","ene-mar","feb-abr","mar-may","abr-jun","may-jul",
                                             "jun-ago","jul-sep","ago-oct",
                                             "sep-nov","oct-dic","nov-ene")))

unemployment_serie
```

Finally, we can graph the results.

```{r, warning=FALSE}
graph <- unemployment_serie %>%
  group_by(sexo) %>%
  plot_ly(x=~interaction(periodo, ano_trimestre), y=~unemployment_rate, group=~sexo,
          type="scatter", color=~sexo, mode="lines+markers") %>% 
  layout(xaxis = list(title = 'Quarter'), 
         yaxis = list(title = 'Unemployment rate (%)'),
         legend = list(orientation = 'h', xanchor = "center", x = 0.5, y = 1.1))

graph
```

# Example 2

Continuing with the National Employment Survey (ENE), in this example we will use the occupational category variable to estimate the number of employed people for each quarter by occupational category.

```{r, message=FALSE,warning=FALSE,results='hide'}
ene_serie <-  get_many_data(dataset = "ene", from = "2022-09-aso", to = "2023-07-jja", col_list = c("ano_trimestre", "mes_central", "cae_especifico", "fact_cal", "categoria_ocupacion"), memory_warning_limit = 10000)
```

```{r, warning=FALSE}
category_serie <- ene_serie %>% 
  map_df(., . %>% 
           mutate(fact_cal = as.numeric(gsub(",", ".", fact_cal)),
                  employed = if_else(cae_especifico %in% 1:7, 1, 0),
                  ocupational_category =  case_when(categoria_ocupacion==1 ~ "Employers",
                     categoria_ocupacion==2 ~ "Own-account workers",
                     categoria_ocupacion==3 ~ "Private wage earners",
                     categoria_ocupacion==4 ~ "Public wage earners",
                     categoria_ocupacion %in% 5:6 ~ "Domestic workers",
                     TRUE ~ "Unpaid family workers"
                     )) %>% 
           filter(employed == 1) %>% 
           group_by(ano_trimestre, mes_central, ocupational_category) %>% 
           summarise(employed = round(sum(employed*fact_cal), 0))) %>% 
  pivot_wider(names_from = ocupational_category, values_from = employed) 

tbl <- category_serie %>%
  kbl() %>%
  kable_paper("hover", full_width = F)

tbl
```
